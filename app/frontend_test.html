<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление студентами</title>
    <style>
        :root {
            --primary: #3f51b5;
            --primary-dark: #303f9f;
            --accent: #ff4081;
            --light: #f5f5f5;
            --dark: #212121;
            --gray: #757575;
            --light-gray: #e0e0e0;
            --white: #ffffff;
            --error: #f44336;
            --success: #4caf50;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        h1 {
            color: var(--primary);
            font-weight: 500;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(63, 81, 181, 0.1);
        }

        .btn-accent {
            background-color: var(--accent);
            color: var(--white);
        }

        .btn-accent:hover {
            background-color: #e91e63;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray);
            font-size: 14px;
        }

        select, input {
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--white);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .students-table th, .students-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        .students-table th {
            background-color: var(--primary);
            color: var(--white);
            font-weight: 500;
            position: sticky;
            top: 0;
        }

        .students-table tr:hover {
            background-color: rgba(63, 81, 181, 0.05);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-studying {
            background-color: #e8f5e9;
            color: var(--success);
        }

        .status-leave {
            background-color: #fff8e1;
            color: #ff8f00;
        }

        .status-expelled {
            background-color: #ffebee;
            color: var(--error);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .empty-state p {
            color: var(--gray);
            margin-top: 10px;
        }

        .loading {
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
        }

        .form-group input, .form-group select {
            width: 100%;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .error-message {
            color: var(--error);
            font-size: 12px;
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .actions {
                width: 100%;
                flex-wrap: wrap;
            }

            .students-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Управление студентами</h1>
            <div class="actions">
                <button class="btn-primary" id="createStudentBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    Добавить студента
                </button>
                <button class="btn-outline" id="createGroupBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    Добавить группу
                </button>
                <button class="btn-outline" id="createProgramBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    Добавить направление
                </button>
                <button class="btn-outline" id="createFacultyBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    Добавить факультет
                </button>
                <button class="btn-outline" id="exportBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8.5 6.5a.5.5 0 0 0-1 0v3.793L6.354 9.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 10.293V6.5z"/>
                        <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                    </svg>
                    Экспорт
                </button>
                <button class="btn-accent" id="importBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg>
                    Импорт
                </button>
            </div>
        </header>

        <div class="filters">
            <div class="filter-group">
                <label for="faculty">Факультет</label>
                <select id="faculty">
                    <option value="">Все факультеты</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="program">Направление</label>
                <select id="program" disabled>
                    <option value="">Все направления</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="group">Группа</label>
                <select id="group" disabled>
                    <option value="">Все группы</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="status">Статус</label>
                <select id="status">
                    <option value="">Все статусы</option>
                    <option value="учится">Учится</option>
                    <option value="академический отпуск">Академотпуск</option>
                    <option value="отчислен">Отчислен</option>
                    <option value="восстановился">Восстановлен</option>
                </select>
            </div>
        </div>

        <div id="students-container">
            <table class="students-table">
                <thead>
                    <tr>
                        <th>ФИО</th>
                        <th>Группа</th>
                        <th>Направление</th>
                        <th>Факультет</th>
                        <th>Статус</th>
                        <th>Форма обучения</th>
                    </tr>
                </thead>
                <tbody id="students-list">
                    <!-- Students will be loaded here -->
                </tbody>
            </table>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
        </div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <h3>Студенты не найдены</h3>
            <p>Попробуйте изменить параметры фильтрации</p>
        </div>
    </div>

    <!-- Модальное окно для создания студента -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Добавить студента</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="studentLastName">Фамилия</label>
                    <input type="text" id="studentLastName" required>
                    <div class="error-message" id="lastNameError"></div>
                </div>
                <div class="form-group">
                    <label for="studentFirstName">Имя</label>
                    <input type="text" id="studentFirstName" required>
                    <div class="error-message" id="firstNameError"></div>
                </div>
                <div class="form-group">
                    <label for="studentMiddleName">Отчество</label>
                    <input type="text" id="studentMiddleName">
                </div>
                <div class="form-group">
                    <label for="studentBirthDate">Дата рождения</label>
                    <input type="date" id="studentBirthDate">
                </div>
                <div class="form-group">
                    <label for="studentEmail">Email</label>
                    <input type="email" id="studentEmail">
                    <div class="error-message" id="emailError"></div>
                </div>
                <div class="form-group">
                    <label for="studentPhone">Телефон</label>
                    <input type="tel" id="studentPhone">
                </div>
                <div class="form-group">
                    <label for="studentAddress">Адрес</label>
                    <input type="text" id="studentAddress">
                </div>
                <div class="form-group">
                    <label for="studentGender">Пол</label>
                    <select id="studentGender">
                        <option value="">Не указан</option>
                        <option value="М">Мужской</option>
                        <option value="Ж">Женский</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="studentBudget">Форма финансирования</label>
                    <select id="studentBudget" required>
                        <option value="бюджет">Бюджет</option>
                        <option value="контракт">Контракт</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="studentStatus">Статус</label>
                    <select id="studentStatus" required>
                        <option value="учится">Учится</option>
                        <option value="академический отпуск">Академический отпуск</option>
                        <option value="отчислен">Отчислен</option>
                        <option value="восстановился">Восстановлен</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="studentGroup">Группа</label>
                    <select id="studentGroup" required>
                        <option value="">Выберите группу</option>
                    </select>
                    <div class="error-message" id="groupError"></div>
                </div>
                <div class="form-group">
                    <label for="studentEducationLevel">Уровень образования</label>
                    <select id="studentEducationLevel" required>
                        <option value="бакалавриат">Бакалавриат</option>
                        <option value="специалитет">Специалитет</option>
                        <option value="магистратура">Магистратура</option>
                        <option value="спо">СПО</option>
                        <option value="аспирантура">Аспирантура</option>
                        <option value="ординатура">Ординатура</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-outline modal-close">Отмена</button>
                <button class="btn-primary" id="saveStudentBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания группы -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Добавить группу</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="groupName">Название группы</label>
                    <input type="text" id="groupName" required>
                    <div class="error-message" id="groupNameError"></div>
                </div>
                <div class="form-group">
                    <label for="groupProgram">Направление</label>
                    <select id="groupProgram" required>
                        <option value="">Выберите направление</option>
                    </select>
                    <div class="error-message" id="groupProgramError"></div>
                </div>
                <div class="form-group">
                    <label for="groupStudyForm">Форма обучения</label>
                    <select id="groupStudyForm" required>
                        <option value="очно">Очно</option>
                        <option value="заочно">Заочно</option>
                        <option value="очно-заочно">Очно-заочно</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="groupEducationLevel">Уровень образования</label>
                    <select id="groupEducationLevel" required>
                        <option value="бакалавриат">Бакалавриат</option>
                        <option value="специалитет">Специалитет</option>
                        <option value="магистратура">Магистратура</option>
                        <option value="спо">СПО</option>
                        <option value="аспирантура">Аспирантура</option>
                        <option value="ординатура">Ординатура</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-outline modal-close">Отмена</button>
                <button class="btn-primary" id="saveGroupBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания направления -->
    <div id="programModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Добавить направление</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="programName">Название направления</label>
                    <input type="text" id="programName" required>
                    <div class="error-message" id="programNameError"></div>
                </div>
                <div class="form-group">
                    <label for="programFaculty">Факультет</label>
                    <select id="programFaculty" required>
                        <option value="">Выберите факультет</option>
                    </select>
                    <div class="error-message" id="programFacultyError"></div>
                </div>
                <div class="form-group">
                    <label for="programEducationLevel">Уровень образования</label>
                    <select id="programEducationLevel" required>
                        <option value="бакалавриат">Бакалавриат</option>
                        <option value="специалитет">Специалитет</option>
                        <option value="магистратура">Магистратура</option>
                        <option value="спо">СПО</option>
                        <option value="аспирантура">Аспирантура</option>
                        <option value="ординатура">Ординатура</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-outline modal-close">Отмена</button>
                <button class="btn-primary" id="saveProgramBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания факультета -->
    <div id="facultyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Добавить факультет</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="facultyName">Название факультета</label>
                    <input type="text" id="facultyName" required>
                    <div class="error-message" id="facultyNameError"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-outline modal-close">Отмена</button>
                <button class="btn-primary" id="saveFacultyBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Скрытый input для импорта -->
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">

    <script>
    // Конфигурация API
    const API_BASE_URL = 'http://127.0.0.1:8140';

    document.addEventListener('DOMContentLoaded', function() {
        // DOM элементы
        const facultySelect = document.getElementById('faculty');
        const programSelect = document.getElementById('program');
        const groupSelect = document.getElementById('group');
        const statusSelect = document.getElementById('status');
        const studentsList = document.getElementById('students-list');
        const loadingElement = document.getElementById('loading');
        const emptyStateElement = document.getElementById('empty-state');

        // Кнопки
        const createStudentBtn = document.getElementById('createStudentBtn');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const createProgramBtn = document.getElementById('createProgramBtn');
        const createFacultyBtn = document.getElementById('createFacultyBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const fileInput = document.getElementById('fileInput');

        // Модальные окна
        const studentModal = document.getElementById('studentModal');
        const groupModal = document.getElementById('groupModal');
        const programModal = document.getElementById('programModal');
        const facultyModal = document.getElementById('facultyModal');

        // Кнопки закрытия модальных окон
        const modalCloseBtns = document.querySelectorAll('.modal-close');

        // Кнопки сохранения
        const saveStudentBtn = document.getElementById('saveStudentBtn');
        const saveGroupBtn = document.getElementById('saveGroupBtn');
        const saveProgramBtn = document.getElementById('saveProgramBtn');
        const saveFacultyBtn = document.getElementById('saveFacultyBtn');

        // Инициализация модальных окон
        function initModals() {
            // Закрытие модальных окон
            modalCloseBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    closeAllModals();
                });
            });

            // Закрытие при клике вне модального окна
            [studentModal, groupModal, programModal, facultyModal].forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeAllModals();
                    }
                });
            });
        }

        function openModal(modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeAllModals() {
            [studentModal, groupModal, programModal, facultyModal].forEach(modal => {
                modal.style.display = 'none';
            });
            document.body.style.overflow = 'auto';
            clearModalErrors();
        }

        function clearModalErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
            });
        }

        // Функции для работы с API
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                alert('Произошла ошибка при загрузке данных');
                return null;
            }
        }

        async function postData(endpoint, data) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Ошибка при сохранении данных');
                }

                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        // Функции загрузки данных
        async function loadFaculties() {
            const faculties = await fetchData('/faculties/');
            if (faculties) {
                facultySelect.innerHTML = '<option value="">Все факультеты</option>';
                faculties.forEach(faculty => {
                    const option = document.createElement('option');
                    option.value = faculty.id;
                    option.textContent = faculty.name;
                    facultySelect.appendChild(option);
                });
            }
        }

        async function loadPrograms(facultyId) {
            const programs = await fetchData(`/faculties/${facultyId}/programs`);
            if (programs) {
                programSelect.innerHTML = '<option value="">Все направления</option>';
                programs.forEach(program => {
                    const option = document.createElement('option');
                    option.value = program.id;
                    option.textContent = program.name;
                    programSelect.appendChild(option);
                });
                loadStudents();
            }
        }

        async function loadGroups(programId) {
            const groups = await fetchData(`/programs/${programId}/groups`);
            if (groups) {
                groupSelect.innerHTML = '<option value="">Все группы</option>';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    groupSelect.appendChild(option);
                });
                loadStudents();
            }
        }

        async function loadStudents() {
            showLoading();

            const facultyId = facultySelect.value;
            const programId = programSelect.value;
            const groupId = groupSelect.value;
            const status = statusSelect.value;

            let endpoint = '/students/';

            if (groupId) {
                endpoint = `/groups/${groupId}/students`;
                if (status) {
                    endpoint += `?status=${status}`;
                }
            } else if (programId) {
                const groups = await fetchData(`/programs/${programId}/groups`);
                if (groups && groups.length > 0) {
                    const groupIds = groups.map(g => g.id).join(',');
                    endpoint = `/students/?group_id=${groupIds}`;
                    if (status) {
                        endpoint += `&status=${status}`;
                    }
                } else {
                    showEmptyState();
                    return;
                }
            } else if (facultyId) {
                const programs = await fetchData(`/faculties/${facultyId}/programs`);
                if (programs && programs.length > 0) {
                    const programIds = programs.map(p => p.id).join(',');
                    const groups = await Promise.all(
                        programs.map(p => fetchData(`/programs/${p.id}/groups`))
                    );
                    const groupIds = groups.flat().map(g => g.id).join(',');

                    if (groupIds) {
                        endpoint = `/students/?group_id=${groupIds}`;
                        if (status) {
                            endpoint += `&status=${status}`;
                        }
                    } else {
                        showEmptyState();
                        return;
                    }
                } else {
                    showEmptyState();
                    return;
                }
            } else if (status) {
                endpoint += `?status=${status}`;
            }

            const students = await fetchData(endpoint);
            hideLoading();

            if (students && students.length > 0) {
                renderStudents(students);
            } else {
                showEmptyState();
            }
        }

        function renderStudents(students) {
            studentsList.innerHTML = '';
            emptyStateElement.style.display = 'none';

            students.forEach(student => {
                const row = document.createElement('tr');

                const groupInfo = student.group ? student.group.name : 'Не указано';
                const programInfo = student.group && student.group.program ?
                    student.group.program.name : 'Не указано';
                const facultyInfo = student.group && student.group.program && student.group.program.faculty ?
                    student.group.program.faculty.name : 'Не указано';

                let statusClass = '';
                let statusText = student.status;

                if (student.status === 'учится') {
                    statusClass = 'status-studying';
                } else if (student.status === 'академический отпуск') {
                    statusClass = 'status-leave';
                    statusText = 'Академ';
                } else if (student.status === 'отчислен') {
                    statusClass = 'status-expelled';
                }

                row.innerHTML = `
                    <td>${student.last_name} ${student.first_name} ${student.middle_name || ''}</td>
                    <td>${groupInfo}</td>
                    <td>${programInfo}</td>
                    <td>${facultyInfo}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${student.education_level}</td>
                `;

                studentsList.appendChild(row);
            });
        }

        function showLoading() {
            loadingElement.style.display = 'flex';
            studentsList.innerHTML = '';
            emptyStateElement.style.display = 'none';
        }

        function hideLoading() {
            loadingElement.style.display = 'none';
        }

        function showEmptyState() {
            studentsList.innerHTML = '';
            emptyStateElement.style.display = 'block';
        }

        // Функции создания сущностей
        async function createStudent() {
            try {
                const studentData = {
                    last_name: document.getElementById('studentLastName').value,
                    first_name: document.getElementById('studentFirstName').value,
                    middle_name: document.getElementById('studentMiddleName').value,
                    birth_date: document.getElementById('studentBirthDate').value || null,
                    email: document.getElementById('studentEmail').value || null,
                    phone_number: document.getElementById('studentPhone').value || null,
                    address: document.getElementById('studentAddress').value || null,
                    gender: document.getElementById('studentGender').value || null,
                    budget_contract: document.getElementById('studentBudget').value,
                    status: document.getElementById('studentStatus').value,
                    group_id: parseInt(document.getElementById('studentGroup').value),
                    education_level: document.getElementById('studentEducationLevel').value
                };

                // Валидация
                if (!studentData.last_name) {
                    document.getElementById('lastNameError').textContent = 'Введите фамилию';
                    return;
                }

                if (!studentData.first_name) {
                    document.getElementById('firstNameError').textContent = 'Введите имя';
                    return;
                }

                if (!studentData.group_id) {
                    document.getElementById('groupError').textContent = 'Выберите группу';
                    return;
                }

                const result = await postData('/students/', studentData);
                if (result) {
                    closeAllModals();
                    loadStudents();
                    resetStudentForm();
                }
            } catch (error) {
                console.error('Error creating student:', error);
                alert(`Ошибка при создании студента: ${error.message}`);
            }
        }

        async function createGroup() {
            try {
                const groupData = {
                    name: document.getElementById('groupName').value,
                    program_id: parseInt(document.getElementById('groupProgram').value),
                    study_form: document.getElementById('groupStudyForm').value,
                    education_level: document.getElementById('groupEducationLevel').value
                };

                // Валидация
                if (!groupData.name) {
                    document.getElementById('groupNameError').textContent = 'Введите название группы';
                    return;
                }

                if (!groupData.program_id) {
                    document.getElementById('groupProgramError').textContent = 'Выберите направление';
                    return;
                }

                const result = await postData('/groups/', groupData);
                if (result) {
                    closeAllModals();
                    resetGroupForm();

                    // Обновляем список групп, если выбрано соответствующее направление
                    if (programSelect.value == groupData.program_id) {
                        loadGroups(groupData.program_id);
                    }
                }
            } catch (error) {
                console.error('Error creating group:', error);
                alert(`Ошибка при создании группы: ${error.message}`);
            }
        }

        async function createProgram() {
            try {
                const programData = {
                    name: document.getElementById('programName').value,
                    faculty_id: parseInt(document.getElementById('programFaculty').value),
                    education_level: document.getElementById('programEducationLevel').value
                };

                // Валидация
                if (!programData.name) {
                    document.getElementById('programNameError').textContent = 'Введите название направления';
                    return;
                }

                if (!programData.faculty_id) {
                    document.getElementById('programFacultyError').textContent = 'Выберите факультет';
                    return;
                }

                const result = await postData('/programs/', programData);
                if (result) {
                    closeAllModals();
                    resetProgramForm();

                    // Обновляем список направлений, если выбран соответствующий факультет
                    if (facultySelect.value == programData.faculty_id) {
                        loadPrograms(programData.faculty_id);
                    }
                }
            } catch (error) {
                console.error('Error creating program:', error);
                alert(`Ошибка при создании направления: ${error.message}`);
            }
        }

        async function createFaculty() {
            try {
                const facultyData = {
                    name: document.getElementById('facultyName').value
                };

                // Валидация
                if (!facultyData.name) {
                    document.getElementById('facultyNameError').textContent = 'Введите название факультета';
                    return;
                }

                const result = await postData('/faculties/', facultyData);
                if (result) {
                    closeAllModals();
                    resetFacultyForm();
                    loadFaculties();
                }
            } catch (error) {
                console.error('Error creating faculty:', error);
                alert(`Ошибка при создании факультета: ${error.message}`);
            }
        }

        // Сброс форм
        function resetStudentForm() {
            document.getElementById('studentLastName').value = '';
            document.getElementById('studentFirstName').value = '';
            document.getElementById('studentMiddleName').value = '';
            document.getElementById('studentBirthDate').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentAddress').value = '';
            document.getElementById('studentGender').value = '';
            document.getElementById('studentBudget').value = 'бюджет';
            document.getElementById('studentStatus').value = 'учится';
            document.getElementById('studentGroup').value = '';
            document.getElementById('studentEducationLevel').value = 'бакалавриат';
            clearModalErrors();
        }

        function resetGroupForm() {
            document.getElementById('groupName').value = '';
            document.getElementById('groupProgram').value = '';
            document.getElementById('groupStudyForm').value = 'очно';
            document.getElementById('groupEducationLevel').value = 'бакалавриат';
            clearModalErrors();
        }

        function resetProgramForm() {
            document.getElementById('programName').value = '';
            document.getElementById('programFaculty').value = '';
            document.getElementById('programEducationLevel').value = 'бакалавриат';
            clearModalErrors();
        }

        function resetFacultyForm() {
            document.getElementById('facultyName').value = '';
            clearModalErrors();
        }

        // Экспорт/импорт
        function exportData() {
            const facultyId = facultySelect.value;
            const programId = programSelect.value;
            const groupId = groupSelect.value;

            let entityType = 'student';

            if (groupId) {
                entityType = 'student';
            } else if (programId) {
                entityType = 'group';
            } else if (facultyId) {
                entityType = 'program';
            }

            window.open(`${API_BASE_URL}/export/excel/?entity_type=${entityType}&include_ids=true`, '_blank');
        }

        async function importData(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE_URL}/import/excel/`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Ошибка импорта данных');
                }

                const result = await response.json();
                alert(`Импорт завершен\nУспешно: ${result.imported_records}\nПропущено: ${result.skipped_records}`);

                // Обновляем данные
                loadFaculties();
                loadStudents();
            } catch (error) {
                console.error('Error importing data:', error);
                alert(`Ошибка при импорте данных: ${error.message}`);
            }
        }

        // Инициализация
        initModals();

        // Обработчики событий для фильтров
        facultySelect.addEventListener('change', function() {
            programSelect.disabled = !this.value;
            programSelect.innerHTML = '<option value="">Все направления</option>';
            groupSelect.innerHTML = '<option value="">Все группы</option>';
            groupSelect.disabled = true;

            if (this.value) {
                loadPrograms(this.value);
            } else {
                loadStudents();
            }
        });

        programSelect.addEventListener('change', function() {
            groupSelect.disabled = !this.value;
            groupSelect.innerHTML = '<option value="">Все группы</option>';

            if (this.value) {
                loadGroups(this.value);
            } else {
                loadStudents();
            }
        });

        groupSelect.addEventListener('change', function() {
            loadStudents();
        });

        statusSelect.addEventListener('change', function() {
            loadStudents();
        });

        // Обработчики для кнопок создания
        createStudentBtn.addEventListener('click', function() {
            fetchData('/groups/').then(groups => {
                const groupSelect = document.getElementById('studentGroup');
                groupSelect.innerHTML = '<option value="">Выберите группу</option>';

                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    groupSelect.appendChild(option);
                });

                openModal(studentModal);
            });
        });

        createGroupBtn.addEventListener('click', function() {
            fetchData('/programs/').then(programs => {
                const programSelect = document.getElementById('groupProgram');
                programSelect.innerHTML = '<option value="">Выберите направление</option>';

                programs.forEach(program => {
                    const option = document.createElement('option');
                    option.value = program.id;
                    option.textContent = program.name;
                    programSelect.appendChild(option);
                });

                openModal(groupModal);
            });
        });

        createProgramBtn.addEventListener('click', function() {
            fetchData('/faculties/').then(faculties => {
                const facultySelect = document.getElementById('programFaculty');
                facultySelect.innerHTML = '<option value="">Выберите факультет</option>';

                faculties.forEach(faculty => {
                    const option = document.createElement('option');
                    option.value = faculty.id;
                    option.textContent = faculty.name;
                    facultySelect.appendChild(option);
                });

                openModal(programModal);
            });
        });

        createFacultyBtn.addEventListener('click', function() {
            openModal(facultyModal);
        });

        // Обработчики для экспорта/импорта
        exportBtn.addEventListener('click', function() {
            exportData();
        });

        importBtn.addEventListener('click', function() {
            fileInput.click();
        });

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                importData(this.files[0]);
            }
        });

        // Обработчики для сохранения данных
        saveStudentBtn.addEventListener('click', function() {
            createStudent();
        });

        saveGroupBtn.addEventListener('click', function() {
            createGroup();
        });

        saveProgramBtn.addEventListener('click', function() {
            createProgram();
        });

        saveFacultyBtn.addEventListener('click', function() {
            createFaculty();
        });

        // Загрузка начальных данных
        loadFaculties();
        loadStudents();
    });
</script>
</body>
</html>